<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Scam Call Monitor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/static/favicon.ico" sizes="any" />
    <link rel="stylesheet" href="/static/css/matrix.css" />
    <style>
      body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #0b1820; color: #d4f1f9; }
      header { display: flex; align-items: center; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid rgba(255,255,255,0.06); }
      header .title { font-weight: 600; }
      header nav a { color: #87f7cf; margin-left: 16px; text-decoration: none; }
      main { padding: 24px; }
      .panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.07); border-radius: 12px; padding: 24px; }
      .hidden { display: none; }
      .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #1a3; box-shadow: 0 0 8px #1a3; }
      .status-dot.idle { background: #444; box-shadow: none; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
      .countdown { display: flex; align-items: center; gap: 24px; }
      .ring { width: 200px; height: 200px; position: relative; }
      .ring svg { transform: rotate(-90deg); }
      .ring .label { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #e8fffb; }
      .ring .label .time { font-size: 44px; font-weight: 800; letter-spacing: 1px; }
      .ring .label .sub { margin-top: 8px; opacity: 0.8; }
      .meta { display: grid; grid-template-columns: auto auto; gap: 8px 12px; }
      .button { padding: 10px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: #0f2a29; color: #9ff3d7; cursor: pointer; }
      .button.primary { background: #14b89a; color: #04221f; border: none; }
      .button[disabled] { opacity: 0.6; cursor: not-allowed; }
      .conversation { height: 420px; overflow: auto; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; }
      .message { display: grid; grid-template-columns: 120px 1fr; gap: 8px; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.06); }
      .message .role.assistant { color: #87f7cf; font-weight: 700; }
      .message .role.callee { color: #d6c3ff; font-weight: 700; }
      footer { margin-top: 16px; opacity: 0.7; font-size: 12px; }
      .caps { font-variant-numeric: tabular-nums; }
      .inline { display: inline-flex; align-items: center; gap: 8px; }
      
      /* Modal styles */
      .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; }
      .modal { background: rgba(11, 24, 32, 0.95); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 24px; min-width: 400px; max-width: 90vw; }
      .modal h3 { margin: 0 0 16px 0; color: #87f7cf; }
      .modal label { display: block; margin-bottom: 8px; color: #d4f1f9; }
      .modal input, .modal textarea { width: 100%; padding: 8px; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: rgba(0,0,0,0.3); color: #d4f1f9; }
      .modal-actions { display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end; }
      .modal textarea { height: 80px; resize: vertical; }
      
      /* Toast notification */
      .toast { position: fixed; top: 20px; right: 20px; background: rgba(255, 107, 107, 0.9); color: white; padding: 12px 16px; border-radius: 8px; z-index: 1001; display: none; }
      
      /* Admin panel */
      .admin-panel { margin-top: 16px; padding: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; }
      .admin-panel h4 { margin: 0 0 12px 0; color: #87f7cf; }
      .env-grid { display: grid; grid-template-columns: 200px 1fr 80px; gap: 8px; align-items: center; margin-bottom: 8px; }
      .env-grid input { padding: 4px 8px; font-size: 12px; }
      .env-grid label { font-size: 12px; }
      
      /* Hidden class */
      .hidden { display: none; }
    </style>
  </head>
  <body data-page="scamcalls">
    <header>
      <div class="title">Scam Call Monitor</div>
      <nav>
        <a href="/scamcalls" aria-current="page">Live</a>
        <a href="/scamcalls/history">History</a>
        <button id="adminBtn" class="button">Admin</button>
      </nav>
    </header>

    <main>
      <div class="panel">
        <div style="display:flex; align-items:center; justify-content: space-between; margin-bottom: 12px;">
          <div style="display:flex; align-items:center; gap:8px;">
            <div style="font-weight:700;">Next Outbound Call</div>
            <span id="statusDot" class="status-dot idle"></span>
          </div>
          <div class="meta">
            <div>Destination</div><div id="destNumber">—</div>
            <div>From</div><div id="fromNumber">—</div>
            <div>Window</div><div id="activeWindow">—</div>
            <div>Caps</div><div id="caps" class="caps">—</div>
          </div>
        </div>

        <div class="grid">
          <!-- Countdown panel -->
          <div id="countdownPanel">
            <div class="countdown">
              <div class="ring">
                <svg viewBox="0 0 120 120" width="200" height="200" aria-hidden="true">
                  <circle cx="60" cy="60" r="54" stroke="rgba(255,255,255,0.08)" stroke-width="12" fill="none"></circle>
                  <circle class="ring-progress" cx="60" cy="60" r="54" stroke="#1ef7c5" stroke-width="12" fill="none" stroke-linecap="round"></circle>
                </svg>
                <div class="label">
                  <div class="time"><span id="cdMinutes">--</span>:<span id="cdSeconds">--</span></div>
                  <div class="sub" id="cdSubtitle">Until next call attempt</div>
                </div>
              </div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <button id="callNowBtn" class="button primary" type="button">Call now</button>
                <button id="greetingBtn" class="button" type="button">Add greeting phrase</button>
                <div style="font-size: 12px; opacity: 0.8;">Served via: <span id="publicUrl">auto</span></div>
              </div>
            </div>
          </div>

          <!-- Active call panel -->
          <div id="callPanel" class="hidden">
            <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px; justify-content: space-between;">
              <div class="inline">
                <div style="font-weight:700;">Active Call</div>
                <span id="callStatusBadge" class="button">Connected</span>
                <div>SID: <span id="callSid">—</span></div>
              </div>
              <div class="inline">
                <button id="listenBtn" class="button" type="button" title="Play live audio">Listen Live</button>
              </div>
            </div>
            <div id="conversation" class="conversation"></div>
          </div>
        </div>

        <footer>
          <div id="appStatus">Status: Initializing...</div>
        </footer>
        
        <!-- Admin Settings Panel (hidden by default) -->
        <div id="adminPanel" class="admin-panel hidden">
          <h4>Admin Settings</h4>
          <div id="envConfigContainer">
            <!-- Environment variables will be loaded here -->
          </div>
          <div style="margin-top: 12px;">
            <button id="saveConfigBtn" class="button">Save Configuration</button>
            <button id="restartBtn" class="button">Restart App to Apply</button>
            <span id="restartStatus" style="margin-left: 8px; font-size: 12px; opacity: 0.8;"></span>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal-backdrop hidden">
      <div class="modal">
        <h3>Admin Login</h3>
        <form id="adminLoginForm">
          <label>
            Username:
            <input type="text" id="adminUsername" required>
          </label>
          <label>
            Password:
            <input type="password" id="adminPassword" required>
          </label>
          <div id="loginError" style="color: #ff6b6b; margin-top: 8px; display: none;"></div>
          <div class="modal-actions">
            <button type="button" id="cancelLoginBtn" class="button">Cancel</button>
            <button type="submit" class="button primary">Login</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Greeting Phrase Modal -->
    <div id="greetingModal" class="modal-backdrop hidden">
      <div class="modal">
        <h3>Add Greeting Phrase</h3>
        <form id="greetingForm">
          <label>
            Greeting phrase (5-15 words):
            <textarea id="greetingText" placeholder="Enter a custom greeting phrase for the next call..."></textarea>
          </label>
          <div id="greetingError" style="color: #ff6b6b; margin-top: 8px; display: none;"></div>
          <div id="wordCount" style="font-size: 12px; opacity: 0.8; margin-top: 4px;">0 words</div>
          <div class="modal-actions">
            <button type="button" id="cancelGreetingBtn" class="button">Cancel</button>
            <button type="submit" class="button primary">Save Phrase</button>
          </div>
        </form>
      </div>
    </div>

    <script src="/static/js/matrix.js"></script>
    <script src="/static/scamcalls.js"></script>
  </body>
</html>
