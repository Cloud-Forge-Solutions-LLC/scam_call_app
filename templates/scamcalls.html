<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Scam Call Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #0b0f14; color: #f0f3f7; margin: 0; }
    header { padding: 16px; background: #0f1720; display: flex; align-items: center; justify-content: space-between; }
    h1 { font-size: 20px; margin: 0; }
    main { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .btn { background: #1f6feb; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    .btn.secondary { background: #334155; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { background: #101826; border: 1px solid #1f2937; border-radius: 8px; padding: 16px; margin-top: 16px; }
    table { width: 100%; border-collapse: collapse; color: #e5e7eb; }
    th, td { padding: 8px; border-bottom: 1px solid #1f2937; text-align: left; }
    .kv { display: grid; grid-template-columns: 250px 1fr; gap: 8px 12px; }
    input[type=text] { width: 100%; background: #0b1220; color: #e5e7eb; border: 1px solid #1f2937; border-radius: 6px; padding: 8px; }
    .warn { color: #fbbf24; font-size: 12px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .badge.red { background: #7f1d1d; color: #fecaca; }
    .badge.green { background: #0f5132; color: #c6f6d5; }
  </style>
</head>
<body>
<header>
  <h1>Scam Call Console</h1>
  <div class="row">
    <a class="btn secondary" href="/scamcalls/history">History</a>
    <a class="btn secondary" href="/admin/logout">Logout</a>
  </div>
</header>
<main>
  <div class="row">
    <button id="callNow" class="btn">Call now</button>
    <button id="addGreeting" class="btn secondary">Add greeting phrase</button>
    <span id="activeBadge" class="badge red">Inactive</span>
  </div>

  <div class="card">
    <h3>Status</h3>
    <div id="status"></div>
    <div id="warnings" class="warn"></div>
  </div>

  <div class="card">
    <h3>Admin Settings</h3>
    <div id="env"></div>
  </div>
</main>

<script>
async function fetchJSON(url, opts = {}) {
  const r = await fetch(url, opts);
  if (!r.ok) throw new Error(await r.text());
  return await r.json();
}

async function refreshStatus() {
  try {
    const s = await fetchJSON('/api/status');
    document.getElementById('activeBadge').textContent = s.within_active_window ? 'Active' : 'Inactive';
    document.getElementById('activeBadge').className = 'badge ' + (s.within_active_window ? 'green' : 'red');
    const lines = [];
    lines.push(`<div>To: ${s.to_number || '(not set)'} | From: ${s.from_number || '(not set)'} </div>`);
    lines.push(`<div>Active window: ${s.active_hours_local} on ${s.active_days.join(', ')}</div>`);
    lines.push(`<div>Call in progress: ${s.call_in_progress}</div>`);
    if (s.seconds_until_next != null) {
      lines.push(`<div>Next attempt in: ${s.seconds_until_next}s</div>`);
    }
    document.getElementById('status').innerHTML = lines.join('');
    const warn = (s.parse_warnings || []).map(w => `<div>Warning: ${w}</div>`).join('');
    document.getElementById('warnings').innerHTML = warn;
  } catch (e) {
    document.getElementById('status').textContent = 'Failed to load status';
  }
}

async function refreshEnv() {
  try {
    const r = await fetchJSON('/api/admin/env');
    const rows = r.editable.map(kv => `
      <tr>
        <td>${kv.key}</td>
        <td><input type="text" value="${kv.value || ''}" data-key="${kv.key}" /></td>
      </tr>
    `).join('');
    document.getElementById('env').innerHTML = `
      <table>
        <thead><tr><th>Key</th><th>Value</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="row" style="margin-top:8px;">
        <button id="saveEnv" class="btn secondary">Save</button>
      </div>
    `;
    document.getElementById('saveEnv').onclick = async () => {
      const inputs = document.querySelectorAll('#env input[data-key]');
      const updates = {};
      inputs.forEach(i => updates[i.dataset.key] = i.value);
      await fetch('/api/admin/env', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ updates })});
      await refreshStatus();
    };
  } catch (e) {
    document.getElementById('env').textContent = 'Failed to load environment settings.';
  }
}

document.getElementById('callNow').onclick = async () => {
  const r = await fetch('/api/call-now', { method: 'POST' });
  if (!r.ok) {
    const t = await r.text();
    alert('Call failed: ' + t);
  } else {
    await refreshStatus();
  }
};

document.getElementById('addGreeting').onclick = async () => {
  const phrase = prompt('Enter a greeting phrase (5-15 words):');
  if (!phrase) return;
  const r = await fetch('/api/next-greeting', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phrase })});
  if (!r.ok) {
    alert('Failed to set greeting.');
  }
};

setInterval(refreshStatus, 2000);
refreshStatus();
refreshEnv();
</script>
</body>
</html>
